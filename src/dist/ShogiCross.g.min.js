var ShogiCross=function(e){"use strict";function t(e){let t=new XMLHttpRequest;if(t.open("GET",`./json/ShogiCross/${e}.json`,!1),t.send(),200===t.status)return JSON.parse(t.responseText);throw Error("Failed to load JSON")}let i=t("canvasFont"),s=t("gameSoft"),r=t("games"),a=t("boards"),o=t("panels"),h=t("pieces"),n=t("pieceRange"),l=t("pieceCost"),c=()=>[...new Set([...Object.values(o).map(({displayText:e})=>e).join("")+Object.values(h).map(({display:e})=>e?e.join(""):"").join("")])].sort().join("");Object.assign(i,{imported:!1,names:"",async importAsync(){if(this.imported)return;let e=c(),t=new Date().getTime().toString();return this.names=i.fonts.map(e=>`"${e[0]}${t}"`).join(",")+",serif",Promise.all(i.fonts.map(async([i,s])=>{let r=i.replace(/ /g,"+"),a=`https://fonts.googleapis.com/css2?family=${r}:wght@${s}&text=${e}`,o=await fetch(a);if(!o.ok)return;let h=(await o.text()).match(/url\(.+?\)/g);if(!h)throw Error("Not found font.");for(let n of h){let l=new FontFace(`${i}${t}`,n);document.fonts.add(l),await l.load().catch(()=>{})}})).then(e=>this.imported=!0)}});let d=[...new Set(Object.values(o).flatMap(({imgSrc:e})=>e??[]).concat(Object.values(h).flatMap(({imgSrc:e})=>e??[])))],g={imported:!1,images:{},async importAsync(){if(!this.imported)return Promise.all(d.map(async e=>{var t;this.images[e]=await (t=e,new Promise(e=>{let i=new Image;i.src=t,i.onload=()=>e(i)}))})).then(e=>this.imported=!0)}},p=e=>"image/"+e.replace("jpg","jpeg");async function f(e,t="image",i="png",s="base64"){let r=p(i),a=document.createElement("a"),o;o="blob"===s?URL.createObjectURL(await new Promise(t=>e.toBlob(t),r)):e.toDataURL(r),a.href=o,a.download=`${t}.${i}`,a.click(),"blob"===s&&URL.revokeObjectURL(a.href)}class ${#a;#b;constructor(e,t,i,s,r,a,h,n,l){Object.assign(this,o[t]),this.ctx=e,this.center=i,this.middle=s,this.width=r,this.height=a,this.left=i-r/2,this.top=s-a/2,this.right=i+r/2,this.bottom=s+a/2,this.borderWidth=h,this.pX=n,this.pY=l,this.selectColor??="#FF000066",this.targetColor??="#00FF0066",this.piece=null,this.isSelected=!1,this.clearTarget(),this.attr??=[]}set isSelected(e){this.#a=!this.hasAttr("keepOut")&&e}get isSelected(){return this.#a}get isTarget(){return 0<this.#b.length}clearTarget(){this.#b=[]}addTarget(e){this.#b.push(e)}hasTarget(e){return this.#b.includes(e)}hasAttr(e){return this.attr.includes(e)}checkRangeMouse(e,t){return this.left<=e&&e<this.right&&this.top<=t&&t<this.bottom}draw(){let{selectColor:e,targetColor:t}=this;this.imgSrc&&g.imported?this.drawImage():this.drawPanel(),this.isSelected&&this.drawMask(e),this.isTarget&&this.drawMask(t),this.piece?.draw()}drawImage(){let{ctx:e}=this,t=this.imgSrc,i=g.images[t];i&&(e.save(),e.translate(this.left,this.top),e.drawImage(i,0,0,this.width,this.height),e.restore())}drawPanel(){let{ctx:e,left:t,top:s,center:r,middle:a,width:o,height:h,displayText:n,textRotate:l}=this;if(e.fillStyle=this.backgroundColor,e.strokeStyle=this.borderColor,e.lineWidth=this.borderWidth,e.save(),e.translate(t,s),e.fillRect(0,0,o,h),this.intersect?(e.lineWidth=this.borderWidth,e.beginPath(),e.moveTo(o/2,0),e.lineTo(o/2,h),e.moveTo(0,h/2),e.lineTo(o,h/2),e.closePath(),e.stroke()):e.strokeRect(0,0,o,h),e.lineWidth=this.borderWidth/2,e.beginPath(),this.borderSlashLeft&&(e.moveTo(0,0),e.lineTo(o,h)),this.borderSlashRight&&(e.moveTo(o,0),e.lineTo(0,h)),e.closePath(),e.stroke(),e.restore(),n){e.save(),e.translate(r,a),e.fillStyle=this.borderColor,e.rotate(l?l*Math.PI/180:0);let c=.6*Math.min(this.width,this.height);e.font=`${c}px ${i.names}`;let d=e.measureText(n).width;e.fillText(n,-d/2,c/2*.8),e.restore()}}drawMask(e){let{ctx:t}=this;t.fillStyle=e,t.fillRect(this.left,this.top,this.width,this.height)}toString(e=!1){return e?`｜${this.text.slice(-1).replace(/　/g,"・")}`:this.text}}class m{static size=45;static useRankSize=!0;static isDrawShadow=!0;static degChars={0:"▲",90:"≫",180:"▽",270:"＜"};static charDegs={};static rankRatio={KR:1,SR:.965,R:.935,UC:.9,C:.865};get rank(){return this.cost<=0?"KR":20<=this.cost?"SR":10<=this.cost?"R":5<=this.cost?"UC":"C"}static getPieces(e,t={}){let i=new Map(Object.entries(JSON.parse(JSON.stringify(h))));for(let[s,r]of i)r.attr??=[],r.unit&&"成"===r.unit&&(r.base=r);for(let[a,o]of i){if(!o.promo||"string"!=typeof o.promo)continue;let n=[...o.promo];for(let l of(o.promo={},n)){let c=i.get(l);c.attr.push("promoted"),c.unit="成",o.promo[l]=c,i.set(l,{...o,...c})}}[...i].forEach(([s,r],a)=>{r.id=a,r.char=s,i.set(s,new m(e,r,t))});let d=Object.fromEntries(i);for(let[g,p]of i)p.alias.forEach((e,t)=>{let i=p.clone(),s=[...i.display];i.displayPtn=t+1,i.display=s,i.alias[t]=g,d[e]=i});return d}static stringToPiece(e,t){if(!t)return null;let[i,s]=[...t],r=m.charDegs[i];if(!r||!e[s])return null;let a=e[s].clone();return a.deg=r,a}static piecesToList(e){return Object.entries(e).sort(([e,{id:t}],[i,{id:s}])=>Math.sign(t-s))}set deg(e){this.rad=e%360*Math.PI/180}get deg(){return this.rad%360/(Math.PI/180)}get left(){return this.center-.8*this.size/2}get top(){return this.middle-this.size/2}get right(){return this.center+.8*this.size/2}get bottom(){return this.middle+this.size/2}get zoom(){let e=this.size/100;return this.useRankSize&&(e*=m.rankRatio[this.rank]),e}constructor(e,t,i={}){let{displayPtn:s=0,deg:a=0,size:o=m.size,useRankSize:h=m.useRankSize,isDrawShadow:c=m.isDrawShadow,isMoved:d=!1}=i;Object.assign(this,t),this.ctx=e,this.display??=[""],this.imgSrc??=null,this.alias=[...this.alias??""],this.displayPtn=s,this.game=r[this.gameName],this.cost=l[this.char]??1,this.center=0,this.middle=0,this.deg=a,this.size=o,this.useRankSize=h,this.isDrawShadow=c,this.isRotateImg??=!0,this.isMoved=d,this.isSelected=!1,this.attr??=[];try{Object.entries(this.range).forEach(([e,t])=>{Array.isArray(t)||(this.range[e]=n[t].map(e=>[...e]))})}catch(g){throw console.error(g),t}}clone(){let{displayPtn:e,deg:t,size:i,isMoved:s}=this;return new m(this.ctx,{...this},{displayPtn:e,deg:t,size:i,isMoved:s})}turnFront(){Object.assign(this,this.base)}promotion(e){let{promo:t}=this;if(!t)throw Error(`promo=${e}, Not plomote piece.`);if(!t in t)throw Error(`promo=${e}, Plomote key is missing.`);if(this.hasAttr("promoted"))throw Error(`promo=${e}, Promoted piece.`);Object.assign(this,t[e]),this.char=e}hasAttr(e){return this.attr.includes(e)}checkRangeMouse(e,t){return this.left<=e&&e<this.right&&this.top<=t&&t<this.bottom}getRange(){let e=0|this.deg,t=JSON.parse(JSON.stringify(this.range));return Object.keys(t).forEach(i=>{if(0!==e){if(![90,180,270].includes(e))throw Error(`deg=${e}, deg need multiple of 90.`);if([90,270].includes(e)){var s;t[i]=(s=t[i])[0].map((e,t)=>s.map(e=>e[t]))}[180,270].includes(e)&&t[i].reverse(),t[i].forEach(t=>{[90,180].includes(e)&&t.reverse()})}}),t}async draw(){let e="#FF000055";this.imgSrc&&g.imported?(this.drawImage(),this.isSelected&&this.drawMaskImage(e)):(this.drawPiece(),this.isSelected&&this.drawMask(e))}drawImage(){let{ctx:e,size:t}=this,i=this.imgSrc[this.displayPtn],s=g.images[i];if(!s)return;e.save(),e.translate(this.center,this.middle),this.isRotateImg&&e.rotate(this.rad);let r,a;.9*s.width<s.height?(r=s.width/s.height*t,a=t):(r=t,a=s.height/s.width*t),e.drawImage(s,-r/2,-a/2,r,a),e.restore()}drawMaskImage(e){let{ctx:t,size:i}=this;t.fillStyle=e,t.save();let s=.9*i,r=i;t.translate(this.center,this.middle),t.fillRect(-s/2,-r/2,s,r),t.restore()}makePath(e){let{ctx:t}=this;t.translate(this.center,this.middle),t.rotate(this.rad),t.beginPath(),t.moveTo(-30*e,-40*e),t.lineTo(0*e,-50*e),t.lineTo(30*e,-40*e),t.lineTo(45*e,50*e),t.lineTo(-45*e,50*e),t.closePath()}drawPieceShadow(e){if(!this.isDrawShadow)return;let{ctx:t}=this;t.save(),t.translate(0,10*e),this.drawMask("#00000066"),t.restore()}drawPiece(){let{ctx:e,game:t,zoom:s}=this,r,a,o;this.hasAttr("promoted")?(r=t.promoteFontColor??t.fontColor??"#000000",a=t.promoteBackgroundColor??t.backgroundColor??"#FFFFFF",o=t.promoteBorderColor??t.borderColor??"#FF3300"):(r=t.fontColor??"#000000",a=t.backgroundColor??"#FFFFFF",o=t.borderColor??"#777777"),e.strokeStyle=o,e.fillStyle=a,e.lineWidth=8*s,this.drawPieceShadow(s),e.save(),this.makePath(s),e.stroke(),e.fill(),e.fillStyle=r;let h=[...""+this.display[this.displayPtn]],n=40*s;e.font=`${n}px ${i.names}`,e.textAlign="center",h.forEach((t,i)=>{let s=1===h.length?n/2:i*n;e.fillText(t,0,s)}),e.restore()}drawMask(e){let{ctx:t,zoom:i}=this;t.fillStyle=e,t.save(),this.makePath(i),t.fill(),t.restore()}toString(){return m.degChars[this.deg]+this.char}}Object.entries(m.degChars).forEach(([e,t])=>{m.charDegs[t]=e});let u=[["default",{isAttack:!1}],["attack",{isAttack:!0}],["start",{isAttack:!1}],["castling",{isAttack:!1}],["enPassant",{isAttack:!0}],["palaceSlash",{isAttack:!1}],["palaceSlash",{isAttack:!0}]],w=[["O",{isOwn:!0}],["o",{}]],v=[["o"],["A",{child:["a"]}],["B",{child:["b"]}],["C",{child:["c"]}],["D",{child:["d"]}],["E",{child:["a","e"]}],["F",{child:["a","f"]}],["G",{child:["b","g"]}],["H",{child:["b","h"]}],["I",{child:["c","i"]}],["J",{child:["c","j"]}],["K",{child:["d","k"]}],["L",{child:["d","l"]}]],_=[["*",{}],["+",{jmps:1}],["|",{jmps:1,moves:1}]];for(let k=1;k<=9;k++)_.push([""+k,{moves:k}]);function y(e){let t=[],i,s;for(let r=0;r<e.length;r++)for(let a=0;a<e[r].length;a++){let o=e[r][a];for(let[h,{isOwn:n}]of w)o===h&&(t.push({isOwn:n,oX:a,oY:r}),n&&([i,s]=[a,r]))}return t.map(e=>(e.offsetX=e.oX-i,e.offsetY=e.oY-s,e))}class S{static #a=new Map([[0," "],[90,">"],[180,"v"],[270,"<"]]);static #b=new Map([...S.#a].map(([e,t])=>[e,RegExp(t,"g")]));static #c=new Map([...S.#a].map(([e,t])=>[t,e]));static #d=new Map([[0,"先手の持駒"],[90,"次手の持駒"],[180,"後手の持駒"],[270,"四手の持駒"]]);static #e=new Map([...S.#d].map(([e,t])=>[t,e]));static #f=["","一","二","三","四","五","六","七","八","九"];static #g=["","十","二十","三十","四十","五十","六十","七十","八十","九十"];static #h(P,x=!0){return!x&&P<=1?"":S.#g[0|P/10]+S.#f[P%10]}static #i(b,C=!0){if(C&&""===b)return 1;if(!isNaN(b))return 0|b;let R=S.#g.findIndex(e=>""!==e&&RegExp("^"+e).test(b));R<0&&(R=0);let L=S.#f.findIndex(e=>""!==e&&RegExp(e+"$").test(b));return L<0&&(L=0),10*R+L}static #j(T){return 10<=T?T:"０１２３４５６７８９"[T%10]}static #k=" ・";static #l(A){return A?S.#a.get(A.deg)+A.char:S.#k}static #m(E,M=0){let j=new Map;return E.stocks.get(M).forEach(({char:e})=>{j.has(e)||j.set(e,0),j.set(e,j.get(e)+1)}),S.#d.get(M)+"："+[...j].map(([e,t])=>e+S.#h(t,!1)).join(" ")}static convSetText(e){let t=[],i=[];e.split(/\r|\n|\r\n/).forEach(e=>{[...S.#e.keys()].some(t=>RegExp(`^${t}`).test(e))?i.push(e):t.push(e.slice(1))});let s=t.slice(2,-1).join(`
`);S.#b.forEach((e,t)=>{s=s.replace(e,m.degChars[t])});let r=i.flatMap(e=>{let[t,i]=e.split(/：/);if(""===i)return"";let s=S.#e.get(t),r=m.degChars[s];return i.split(/\s/).map(e=>{let t=e[0],i=e.slice(1);return(r+t).repeat(S.#i(i))})}).join("");return`${s}
${r}`}static getText(e){let{field:t,xLen:i,players:s,stand:r}=e,a=` ${[...Array(i).keys()].map(e=>` ${S.#j(i-e)}`).join("")}
+${Array(i).fill("---").join("")}+
`,o=`
+${Array(i).fill("---").join("")}+`,h=`
`,n=`${S.#m(r,180)}
`,l=`${S.#m(r,0)}`;return 2!==s&&(n=`${S.#m(r,270)}
`+n,l=`${S.#m(r,90)}
`+l),n+a+t.map((e,t)=>"|"+e.map(e=>S.#l(e.piece)).join("")+"|"+S.#h(t+1)).join(h)+o+`
`+l}}class F{static #a=[180,90,270,0];constructor(e){this.board=e;let{top:t,right:i,bottom:s,width:r,height:a,panelWidth:o,panelHeight:h,xLen:n,yLen:l}=e;this.clear(),this.left=1.02*i,this.top=t,this.width=r/2,this.height=a,this.right=this.left+this.width,this.bottom=s,this.pitchWidth=o/2,this.pitchHeight=h,this.xLen=n,this.yLen=l}clear(){this.stocks=new Map(F.#a.map(e=>[e,[]]))}releasePiece(e,t={}){let{deg:i,i:s}=t,{board:r}=this,a=this.stocks.get(i);e.piece=a[s],a[s].center=e.center,a[s].middle=e.middle,r.addRecord(e,{end:"打"}),a.splice(s,1)}add(e){let t=this.stocks.get(e.deg);e.turnFront(),t.push(e),t.sort((e,t)=>Math.sign(e.id-t.id))}capturePiece(e,t,i=!1,s=!1){s||!t||!(i||e.hasAttr("capture"))||t.hasAttr("king")||t.hasAttr("cantCapture")||(t.deg=e.deg,t.isMoved=!0,this.add(t))}draw(){let{board:e,left:t,top:i,width:s,height:r,pitchWidth:a,pitchHeight:o}=this,{ctx:h,xLen:n,yLen:l}=e;h.fillStyle=e.backgroundColor,h.strokeStyle=e.borderColor,h.lineWidth=e.borderWidth,h.save(),h.translate(t,i),h.fillRect(0,0,s,r),h.strokeRect(0,0,s,r),h.restore(),[...this.stocks.values()].forEach((e,s)=>{let r=0;e=e.slice(-l/4*n);for(let h=0|l/4*s;h<l/4*(s+1);h++)for(let c=0;c<n;c++){let d=t+a*(c+1),g=i+o*(h+1),p=e[r++];if(null==p)break;p.center=d,p.middle=g,p.draw()}})}toString(e=!1){let{xLen:t}=this.board,i=[...this.stocks.values()].flat().filter(e=>e),s=0<i.length?`
`+"―".repeat(2*t)+`
`:"",r=i.map(e=>""+e).join("");if(!e)for(let a of(s="",Object.values(m.degChars)))r=r.replace(a,`
${a}持駒：${a}`);return s+r}}let z=Object.keys(m.degChars),D=()=>({panel:null,piece:null});class W{static run(e,t){let{playBoard:i,playPieces:s,onDrawed:r}=t,a=s.some(({gameName:e},t)=>1<t&&e)?4:2,o=new W(e,i,{...t,players:a,onDrawed:r});return s.forEach(({gameName:e,pieceSet:t},i)=>{if(e){t??="default";try{o.putStartPieces(i,e,t)}catch{}}}),o.onDrawed=r,o}constructor(e,t,s){let{players:r=2,canvasWidth:o,canvasHeight:h,canvasFit:n="overflow",boardLeft:l=5,boardTop:c=5,panelWidth:d=50,panelHeight:p=0|1.1*d,pieceSize:f=0|.9*d,useRankSize:w=!0,isDrawShadow:k=!0,borderWidth:S=Math.min(d,p)/30,useStand:P=!1,backgroundColor:x="#00000000",autoDrawing:b=!0,onDrawed:C,onGameOver:R=e=>alert(`プレイヤー${e+1}の敗北です。`),freeMode:L=!1}=s,T=i.importAsync(),A=g.importAsync();this.canvas=e;let E=e.getContext("2d");if(E.clearRect(0,0,e.width,e.height),this.ctx=E,this.pieces=m.getPieces(E,{size:f,useRankSize:w,isDrawShadow:k}),Object.assign(this,a[t]),![2,4].includes(r))throw Error(`players=${r}, players need 2 or 4.`);this.players=r,this.left=l,this.top=c,this.panelWidth=d,this.panelHeight=p,this.borderWidth=S,this.pieceSize=f,this.canvasBackgroundColor=x,this.field=this.field.map((e,t)=>[...e].map((e,i)=>new $(E,e,l+d*(i+1),c+p*(t+1),d,p,S,i,t))),this.xLen=this.field[0].length,this.yLen=this.field.length,this.width=this.panelWidth*(this.xLen+1),this.height=this.panelHeight*(this.yLen+1),this.right=l+this.width,this.bottom=c+this.height,this.stand=new F(this),e.width=o??(P?this.stand.right:this.right)+5,e.height=h??this.bottom+5;let{style:M}=e;"overflow"===n?(""===M.maxWidth&&(M.maxWidth="97vw"),""===M.maxHeight&&(M.maxHeight="97vh")):"horizontal"===n?""===M.width&&(M.width="97vw"):"vertical"===n?""===M.height&&(M.height="97vh"):"parentOverflow"===n?(""===M.maxWidth&&(M.maxWidth="100%"),""===M.maxHeight&&(M.maxHeight="100%")):"parentHorizontal"===n?""===M.width&&(M.width="100%"):"parentVertical"===n&&""===M.height&&(M.height="100%"),this.autoDrawing=b,b&&(T.then(()=>this.draw()),A.then(()=>this.draw()),this.draw()),this.onDrawed=C,this.onGameOver=R,this.gameAlives=new Map([...Array(this.players).keys()].map(e=>[this.#a(e),!0])),this.freeMode=L,this.record=[],this.uiControl=function e(t){let i=!1,s=[],r=null,a=null,{canvas:o}=t,h=(e,i,r=()=>{})=>{let a=window.getComputedStyle(o),h=e.target.getBoundingClientRect(),n=o.width/parseFloat(a.width),l=o.height/parseFloat(a.height);if(e.clientX)n*=e.clientX-h.left,l*=e.clientY-h.top;else if(0<e.touches.length){if(1<e.touches.length)return;n*=e.touches[0].clientX-h.left,l*=e.touches[0].clientY-h.top}else e.preventDefault(),[n,l]=s;t.field.forEach((e,t)=>e.forEach((e,s)=>i(e,n,l,s,t))),r(n,l),t.draw(),s=[n,l]},n=e=>{i=!0,h(e,(i,s,a)=>{let{piece:o,pX:h,pY:n}=i;o&&i.checkRangeMouse(s,a)&&(e.preventDefault(),o.isSelected=!0,r=i,function e(t,i,s,r){let{field:a,yLen:o,enPassant:h}=t;function n(e,t){return a[t]&&a[t][e]&&!a[t][e].hasAttr("keepOut")}function l(e){return e.piece&&i.hasAttr("po")&&e.piece.hasAttr("po")}function c(e,n,c,d="",g=!0){var p;if(!a[c]||!a[c][n])return!1;let f=a[c][n];return!(!f||l(f)||(p=f).piece&&!i.isMoved&&!p.piece.isMoved&&i.hasAttr("pao")&&i.cost<p.piece.cost||"enPassant"===d&&!h.isTarget(f,i)||i.hasAttr("inPalace")&&!f.hasAttr("palace")||0===d.indexOf("palace")&&!(f.hasAttr(d)&&a[r][s].hasAttr(d))||i.hasAttr("unCrossRiver")&&o-(0|o/2)<=t.getRow(n,c,i.deg))&&(e?!!a[c][n].piece&&(!g||i.deg!==a[c][n].piece.deg):!a[c][n].piece)}function d(e,t,i,a,o){for(let h of t)for(let l=0;l<e.length;l++)for(let d=0;d<e[l].length;d++){let[g,p]=[d+s-a,l+r-o];if(!(!n(g,p)||c(i,0|g,0|p,"",!1)||e[l][d]!==h))return!0}return!1}function g(e,t,s){let r=a[s][t];r.addTarget(e),h.setTarget(r,i)}function p(e,[t,{isAttack:i}],{oX:a,oY:o,isOwn:h}){if(h)for(let[l,{child:p=[]}={}]of v)for(let f=0;f<e.length;f++)for(let $=0;$<e[f].length;$++){let[m,u]=[$+s-a,f+r-o];!n(m,u)||!c(i,m,u,t)||e[f][$]!==l||d(e,p,!1,a,o)||g(t,m,u)}}function f(e,[t,{isAttack:i}],{oX:o,oY:h,isOwn:d,offsetX:p,offsetY:f}){if(!(!d&&!c(!1,s+p,r+f)))for(let[$,{jmps:m=0,moves:u=0}={}]of _){let w=!u||0===u;for(let v=h-1;v<=h+1;v++)for(let k=o-1;k<=o+1;k++){if(e[v][k]!==$||k===o&&v===h)continue;let y=m||0,S=u||0,[P,x]=[k-o,v-h];for(let b=s,C=r;;){b+=P,C+=x;let R=b+p,L=C+f;if(!n(R,L)||!w&&0===S)break;let T=0===y;T&&c(i,R,L,t,T)?(S--,g(t,R,L)):m<1&&S--;let A=a[L][R];if(A.piece&&(y--,T||l(A)))break}}}}!function(){let e=i.getRange();for(let t of(e.attack??=e.default,u)){let s=t[0];if(i.isMoved&&["start","castling"].includes(s))continue;let r=e[s];if(r)for(let a of y(r))p(r,t,a),f(r,t,a)}}()}(t,o,h,n))},(i,s)=>{for(let[r,o]of t.stand.stocks)for(let h=o.length-1;0<=h;h--)if(o[h].checkRangeMouse(i,s)){e.preventDefault(),o[h].isSelected=!0,a={deg:r,i:h};return}})},l=e=>{i&&(r||a)&&h(e,(e,t,i)=>{e.isSelected=e.checkRangeMouse(t,i)})},c=e=>{i=!1,h(e,(e,i,s)=>{e.checkRangeMouse(i,s)&&(r&&t.movePiece(r,e),a&&!e.piece&&t.stand.releasePiece(e,a))}),h(e,e=>{e.piece&&(e.piece.isSelected=!1),e.isSelected=!1,e.clearTarget()},()=>{for(let[e,i]of t.stand.stocks)for(let s=i.length-1;0<=s;s--)i[s].isSelected=!1;r=null,a=null})};return o.addEventListener("mousedown",n),o.addEventListener("mousemove",l),o.addEventListener("mouseup",c),o.addEventListener("touchstart",n),o.addEventListener("touchmove",l),o.addEventListener("touchend",c),{removeEvent(){o.removeEventListener("mousedown",n),o.removeEventListener("mousemove",l),o.removeEventListener("mouseup",c),o.removeEventListener("touchstart",n),o.removeEventListener("touchmove",l),o.removeEventListener("touchend",c)}}}(this),this.enPassant=new class e{constructor(){this.degs={},z.forEach(e=>this.degs[e]=D())}clear(e){this.degs[e]=D()}setTarget(e,t){e.hasTarget("start")&&t.hasAttr("enPassant")&&(this.degs[t.deg].panel=e)}setMoved(e){let{piece:t}=e,i=this.degs[t.deg];t&&e===i.panel?i.piece=t:this.clear(t.deg)}isTarget(e,t){return!e||!e.piece||!!e.piece.hasAttr("enPassant")&&e.piece===this.degs[e.piece.deg].piece}}}close(){this.uiControl.removeEvent()}#a(O){let I=O;0<I&&I<4&&(I=0|360*I/this.players);do I=(I+360)%360;while(I<0);return I}rotateField(e){let{xLen:t,yLen:i}=this;if(0!==(e=this.#a(e))){if(![90,180,270].includes(e))throw Error(`deg=${e}, deg need multiple of 90.`);if([90,270].includes(e)){var s;if(t!==i)throw Error(`cols=${t} != rows=${i}, Not rows = cols.`);this.field=(s=this.field)[0].map((e,t)=>s.map(e=>e[t]))}[180,270].includes(e)&&this.field.reverse(),this.field.forEach(t=>{t.forEach(t=>{t.piece&&(t.piece.deg+=e)}),[90,180].includes(e)&&t.reverse()})}}putStartPieces(e,t,i="default"){let{pieces:s}=this,a=this.#a(e);this.rotateField(a);let o=r[t].position[this.xLen][i];if(!o)throw Error(`games["${t}"].position["${this.xLen}"]["${i}"]is null.`);o.forEach((e,t)=>{if(e.length<this.xLen)throw Error(e.join(""));let i=t+this.yLen-o.length;[...e].forEach((e,t)=>{if(!s[e])return;let r=s[e].clone(),a=this.field[i][t];r.center=a.center,r.middle=a.middle,a.piece=r})}),this.rotateField(-a),this.autoDrawing&&this.draw()}putNewPiece(e,t,i,s,r={}){let{displayPtn:a=0,isMoved:o=!1}=r,{pieces:h}=this,n=this.#a(s);"string"==typeof e&&(e=new m(this.ctx,h[e],{displayPtn:a,deg:n,isMoved:o}));let l=this.field[i][t];e.center=l.center,e.middle=l.middle,l.piece=e,this.autoDrawing&&this.draw()}setTextPieces(e){let{field:t,pieces:i,xLen:s,yLen:r}=this,a="持駒：";0<e.indexOf(a)&&(e=S.convSetText(e));let o=[e].concat([..."┏━┯┓┗┷┛┃│┠─┼┨―"],Object.values(m.degChars).map(e=>`
`+e+a)).reduce((e,t)=>e.replace(RegExp(t,"g"),"")).replace(/\n\n/g,`
`).replace(/　/g,"・").trim().split(/\n/).map(e=>e.match(/.{2}/g));for(let h=0;h<r;h++)for(let n=0;n<s;n++)try{let l=o[h][n],c=m.stringToPiece(i,l);c.center=t[h][n].center,c.middle=t[h][n].middle,t[h][n].piece=c}catch{t[h][n].piece=null}this.stand.clear();let d=o[r];d&&d.forEach(e=>{let t=m.stringToPiece(i,e);t&&this.stand.add(t)}),this.autoDrawing&&this.draw()}getRow(e,t,i,s=0){let{xLen:r,yLen:a}=this;return 0===(i=this.#a(i+s))?a-1-t:90===i?e:180===i?t:270===i?r-1-e:-1}getCol(e,t,i,s=0){let{xLen:r,yLen:a}=this;return 0===(i=this.#a(i+s))?e:90===i?a-1-t:180===i?r-1-e:270===i?t:-1}checkCanPromo(e){let{yLen:t}=this,{piece:i,pX:s,pY:r}=e,{deg:a}=i,[o,h]=[i.game.promoLine,i.forcePromoLine].map(e=>t-e-(0|this.promoLineOffset)),n;return{canPromo:o<=(n=this.sidePromo?Math.max(...Object.keys(m.degChars).map(e=>0|e).filter(e=>e!==a).map(e=>this.getRow(s,r,e,180))):this.getRow(s,r,a)),forcePromo:h<=n}}#b(){[...this.gameAlives].forEach(([e,t],i)=>{t&&(this.field.some(t=>t.some(({piece:t})=>t&&t.deg===e&&t.hasAttr("king")))||(this.gameAlives.set(e,!1),this.onGameOver(i)))})}#c(X,Y,H,B){let{freeMode:N}=this,{piece:G}=Y;if(!G.promo||G.hasAttr("promoted")||!H){this.addRecord(Y,{fromPanel:X});return}do for(let[U,{name:K}]of Object.entries(G.promo))if(confirm(`成りますか?
	${G.char}:${G.name}
	　↓
	${U}:${K}`)){this.addRecord(Y,{fromPanel:X,end:"成"}),G.promotion(U);return}while(!N&&B);this.addRecord(Y,{fromPanel:X,end:"不成"})}movePiece(e,t){let{stand:i,freeMode:s,enPassant:r}=this;if(!e||t.hasAttr("keepOut")||t.piece===e.piece||t.piece?.deg===e.piece.deg||!this.freeMode&&!t.isTarget)return;let{canPromo:a,forcePromo:o}=this.checkCanPromo(e);i.capturePiece(e.piece,t.piece,t.hasAttr("capture"),t.hasAttr("cantCapture")),t.piece=e.piece,e.piece=null;let{piece:h}=t;h.center=t.center,h.middle=t.middle,h.isMoved=!0;let n=this.checkCanPromo(t);a||=n.canPromo,o||=n.forcePromo,r.setMoved(t),this.#c(e,t,a,o),this.#b()}addRecord(e,t={}){let{fromPanel:i,end:s=""}=t,{piece:r}=e;this.record.push({to:{pX:e.pX,pY:e.pY},from:{pX:i?.pX,pY:i?.pY},deg:r.deg,pieceChar:r.char,end:s})}getTextRecord(){let e=({pX:e})=>null==e?"*":(this.xLen-e).toString(36),t=({pY:e})=>null==e?"*":(e+1).toString(36);return this.record.map(({to:i,from:s,deg:r,pieceChar:a,end:o})=>`${m.degChars[r]}${e(i)}${t(i)}${a}${o} (${e(s)}${t(s)})`).join(`
`)}draw(){let{ctx:e,canvas:t,left:i,top:s,width:r,height:a,panelWidth:o,panelHeight:h}=this;e.restore(),e.save(),e.clearRect(0,0,t.width,t.height),e.fillStyle=this.canvasBackgroundColor,e.fillRect(0,0,t.width,t.height),e.fillStyle=this.backgroundColor,e.lineWidth=this.borderWidth,e.strokeStyle=this.borderColor,e.save(),e.translate(i,s),e.fillRect(0,0,r,a),e.strokeRect(0,0,r,a),e.translate(o/2,h/2),e.strokeRect(0,0,r-o,a-h),e.restore(),this.stand.draw(),this.field.forEach(e=>{e.forEach(e=>{e.draw()})}),this.onDrawed&&this.onDrawed(this)}getText(e="default"){return"bod"===e?S.getText(this):this.toString("compact"===e)}toString(e=!1){let{xLen:t}=this,i="",s="",r="",a="",o=`
`;return e||(i=`┏${Array(t).fill("━━").join("┯")}┓
`,s=`
┗${Array(t).fill("━━").join("┷")}┛`,r="┃",a="│",o=`
┠${Array(t).fill("──").join("┼")}┨
`),i+this.field.map(t=>r+t.map(t=>""+(t.piece??t.toString(e))).join(a)+r).join(o)+s+this.stand.toString(e)}async downloadImage(e,t){await f(this.canvas,e,t)}}return e.Board=W,e.Piece=m,e.boards=a,e.canvasFont=i,e.canvasImage=g,e.gameSoft=s,e.games=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),e}({});